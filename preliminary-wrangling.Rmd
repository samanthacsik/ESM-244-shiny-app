---
title: "Prelim wrangling"
author: "An Bui, Sam Csik"
date: "2/11/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r set up}
#### libraries ####
library(sf)
library(tidyverse)
library(tmap)
library(leaflet)
library(ggrepel)
library(ggspatial)
library(RColorBrewer)
library(raster)

#### data ####
# school enrollment
school_enrollment <- read_csv("school_enrollment.csv")

# number of students rated "Prepared" for college based on a variety of criteria
college_preparedness <- read_csv("college_preparedness.csv")

# educational attainment for CA counties, percent of people age 25 and up with college degree or higher
edu_att <- read_csv("edu_att_filtered.csv") %>% 
       dplyr::select("county_name", "race_eth_code", "race_eth_name", "geotype", "geotypevalue", "geoname",  "county_fips", "region_name", "region_code", "strata_one_code", "strata_one_name", "numerator",   "denominator", "estimate", "LL_95CI", "UL_95CI", "SE", "RSE", "CA_RR")

edu_att$race_eth_code <- as.numeric(edu_att$race_eth_code)
edu_att$race_eth_name <- as.character(edu_att$race_eth_name)
edu_att$geotype <- as.character(edu_att$geotype)
edu_att$geotypevalue <- as.numeric(edu_att$geotypevalue)
edu_att$county_name <- as.character(edu_att$county_name)
edu_att$county_fips <- as.numeric(edu_att$county_fips)
edu_att$region_name <- as.character(edu_att$region_name)
edu_att$region_code <- as.numeric(edu_att$region_code)
edu_att$strata_one_code <- as.numeric(edu_att$strata_one_code)
edu_att$strata_one_name <- as.character(edu_att$strata_one_name)
edu_att$numerator <- as.numeric(edu_att$numerator)
edu_att$denominator <- as.numeric(edu_att$denominator)
edu_att$estimate <- as.numeric(edu_att$estimate)
edu_att$LL_95CI <- as.numeric(edu_att$LL_95CI)
edu_att$UL_95CI <- as.numeric(edu_att$UL_95CI)
edu_att$SE <- as.numeric(edu_att$SE)
edu_att$RSE <- as.numeric(edu_att$RSE)
edu_att$CA_RR <- as.numeric(edu_att$CA_RR)

# California counties
ca_counties <- read_sf(".", layer = "california_county_shape_file") %>% 
  rename(county_name = NAME)

# set same projection system as ca_eco
st_crs(ca_counties) = 4326

# merge counties and edu_att
# edu_att_full <- merge(edu_att, ca_counties) %>% 
#   filter(geotype == "CO" &
#            race_eth_name != "Total") %>% 
#   arrange(-estimate)

```

```{r wrangle college preparedness}
#### filter ####
cp_subset <- college_preparedness %>% 
  # filter only for school reports
  filter(rtype == "S" |
           # take out summary rows for all races
           studentgroup != "ALL") %>% 
  # select desired columns
  select(cds, rtype, schoolname, districtname, countyname, studentgroup, currdenom, curr_prep, curr_prep_pct, curr_prep_apexam, curr_prep_apexam_pct, curr_prep_ibexam, curr_prep_ibexam_pct, curr_prep_collegecredit, curr_prep_collegecredit_pct)
# idk about this data because there could be individuals who earned "Prepared" by taking AP classes AND fulfilling class requirements, but there's no info on how many students overlap between categories (if that makes sense)
```

```{r educational attainment by county and race}
edu_att_filter <- edu_att %>% 
  filter(geotype == "CO" &
           race_eth_name != "Total")

alameda <- edu_att_filter %>% 
  filter(county_name == "Alameda")

edu_att_bar <- ggplot(edu_att_filter, aes(x = race_eth_name, y = estimate)) +
  geom_bar(stat = "identity") +
  facet_wrap(~county_name)
edu_att_bar

edu_att_alameda <- ggplot(alameda, aes(x = reorder(race_eth_name, -estimate), 
                                       y = estimate)) +
  geom_bar(stat = "identity", aes(fill = race_eth_name)) +
  scale_fill_brewer(palette = "YlGnBu") +
  theme_minimal() +
  labs(x = "Race", 
       y = "Percentage with college degree or higher", 
       title = "Percentage of population 25 years or older with college degree or higher - Alameda County")
edu_att_alameda
```




